---
weight: 1
title: 引言：我们需要怎样的平台
---

# 引言：我们需要怎样的平台

> ……然而，**Cranberry 作为“下一代 CTF 竞赛系统”的愿景，是使那些曾经因平台限制而无法发挥的出题人的脑洞，得以亮相在选手面前**。于是，Cranberry 必然要设计得足够灵活，这不是一件简单的事。越灵活的系统，越容易过度设计，架构变得越来越复杂，最终每次添加功能都成为一场灾难。  
> -- Ruan Xingzhi, [2025/8/11](https://www.ruanx.net/cranberry-ctf-architecture/)

CTF 平台的开发者，一直在“过度设计”与“缺乏扩展性”之间维持平衡。Cranberry 的核心目标，就是在拥有极致扩展性的前提下，维持设计的简洁。过去的经验告诉我们，如果我们设计时不考虑好各种各样的使用场景，那么我们写出来的东西八成不可扩展；但如果我们什么功能都想“既要又要”，那么八成会走向过度设计。本文将给出一个我们理想中的竞赛平台的样子，以及，更重要地，说明我们准备放弃哪些功能。


### 特性清单

简而言之，笔者认为，一个理想的平台，应该拥有以下特性：
- 可编程的 checker
- 可在靶机侧运行的 checker
- 在一场赛事中，同时包含解题、patch、AWDP、AWD、KoH 题目
- 支持多种靶场后端（docker 单容器、docker 多容器、虚拟机……）
- 灵活的计分方式（动态分、前三血、AWD/AWDP 题目每轮次计分、KoH 一次性更新所有人分数……）
- 可以有多个复杂的排行榜

### 为什么支持高级 checker
图灵完备的 checker 是 Blueberry 的特色功能。无论静态 flag 还是动态 flag，在 Blueberry 上，checker 都是一段 Python 代码。这个巧妙的设计，轻松实现了许多有趣的功能，例如：

- （动态 flag）`dynamic_flag = AES(flag_key, f"{task_id}|{user_id}")`
- （压力测试）flag 是 1000 ~ 9999 之内的整数，对每个参赛者都不一样，你猜去吧！
- （多解）`def check(s): return s == "H3CTF{猕猴}" or s =="H3CTF{猴子}"`

不过，Blueberry 的 checker 是在平台侧运行的。Cranberry 则更进一步：checker 不仅可以在平台侧运行，还可以在靶机侧运行。我们马上能想象到它的用途：

- 更丰富的 check 逻辑。例如，选手在靶机上弹计算器，checker 去检查进程列表里有没有叫做 calc 的进程；要求选手写一段代码，checker 将它编译好之后用预定义的 input 运行，按 OI 风格计时和评测……
- patch/AWD 题的修复检查
- AWD/AWDP 题的服务正常性检查

### 为什么支持如此多种题目类型和靶场类型

为了训练。没有靶场就无法进行 AWD 实战训练，这是很多战队 AWD 水平欠缺的最大原因。在设计 AWD 支持的过程中，我们发现，其实我们也可以几乎无代价地支持其他各种赛制。相关内容将在《架构设计》文章中描述。

尽管 docker（以及 docker compose）已经成为了 CTF 解题赛靶机的事实标准，但有些事情是 docker 做不了的：
- 容器的内核版本永远与主机一致，所以无法出依赖特定内核的题目
- 无法支持 Windows 靶机，也就无法训练 ms17-010 等漏洞利用
- 无法对所有参赛者复现一模一样的网络拓扑。例如，在多层内网渗透时，你不可能让所有选手都看到相同的数据库服务器IP

所以，我们有必要引入 vm 靶机支持。暂定使用 PVE 实现。

### 为什么放弃团队功能

团队功能会给平台带来沉重的开发负担，但收益寥寥。这些负担包括：靶机管理变得更加复杂（例如，用户可否关闭团队中其他人的靶机、靶机数量限制是对人还是对团队）；分数计算变得更加复杂；参赛逻辑变得很难理清（队员进入/离开队伍要不要带上分数走？还是说在比赛期间禁止队伍人员变动？）。此外，可以预见地，用户模块在各种赛事环境中是千变万化的——有的比赛要 OAuth，有的比赛要提前导入参赛者名单，有的比赛要允许随时自由组队参赛……如果实装团队功能，则二次开发者多少要了解团队功能的内部逻辑，也会加重二次开发者的负担。

有一种设计可以缓解这一问题，即我们不再关心参赛的是用户还是团队，我们只关心“参赛实体”。在个人赛中，他自己就关联一个参赛实体；在团队赛中，整个团队关联一个参赛实体。靶机限制是施加给参赛实体的，排行榜也是参赛实体的榜单，我们无需给个人赛和团队赛各写一份代码。

然而，回过头来想想，我们真的需要显式地支持团队功能吗？如果一场比赛是团队赛，则所有人都去登录队长的账号就行了。一个团队一般也没有多大，几人而已，队长完全可以管理。固然，这样做会产生一些不便（例如无法追踪具体是谁提交了 flag），但比起支持团队赛的成本，相对更可以接受。事实上，Blueberry 就曾经被用于团队赛，采用的正是“所有人都登录同一个账号”策略。


### 为什么放弃单平台多赛事

单平台多赛事是一项极具吸引力的功能。举两个例子：（一）对于互联网上的竞赛，组织方能以单一的基础设施去服务各项赛事，无需多次部署，选手也无需多次注册账号，皆大欢喜；（二）即使对于线下赛，我们也可以用单平台多赛事功能实现 day0 环境测试赛、day1 初赛、day2 决赛。

然而，权衡之后，我们决定放弃单平台多赛事。原因很简单：一旦引入多赛事，则数据库中几乎所有的表都要新增一列，SQL 会更加复杂，对二次开发更不友好。

对于 Blueberry 而言，“多次部署”是痛点，因为题目不能导入导出。然而，Cranberry 采用了新的架构，竞赛平台变成了很薄的一层，它自己不负责维护题目，而是从题目中心取题目。这样一来，即使为每场赛事部署新平台，也无非是起一个平台服务器，连接到题目中心，选择哪些题出现在赛场上，代价很低。从另一方面说，“公共平台支撑全部竞赛”这个愿望也不一定能实现。很多赛事都有二次开发需求（例如特殊的排行榜），这导致它们不能使用公共平台。