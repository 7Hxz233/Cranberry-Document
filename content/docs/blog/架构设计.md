---
weight: 3
title: Cranberry 架构概览
---

# Cranberry 架构概览

## 基本结构

逻辑上说，**Cranberry 由三层子系统构成：平台、题目中心、实例管理器**。在实践上，实例管理器一般是现成的（例如 Docker Swarm）。我们只规定平台与题目中心之间的通讯接口，不限制题目中心与实例管理器的通讯方式。每种靶机形式都会有自己的题目中心，例如 docker 题目中心、PVE 题目中心。**一个平台可以连接多个题目中心，一个题目中心也可以给多个平台供题。**

```mermaid
%% Cranberry 系统架构图
%% 一个平台 ↔ 多个题目中心 ↔ 各自实例管理器（通讯方式不限）

graph TD
    subgraph 平台层
        PF[Platform]
    end

    subgraph 题目中心层
        CC1[Challenge-Center-Docker]
        CC2[Challenge-Center-PVE]
        CCn[...其它题目中心]
    end

    subgraph 实例管理层
        IM1[Docker Swarm]
        IM2[PVE]
        IMn[...]
    end

    %% 平台与题目中心：规范接口
    PF <-->|规范接口| CC1
    PF <-->|规范接口| CC2
    PF <-->|规范接口| CCn

    %% 题目中心与实例管理器：通讯方式不限
    CC1 <-.-> IM1
    CC2 <-.-> IM2
    CCn <-.-> IMn

    %% 说明
    classDef plat fill:#b3e5fc,stroke:#01579b
    classDef cc   fill:#c8e6c9,stroke:#1b5e20
    classDef im   fill:#ffe0b2,stroke:#e65100

    class PF plat
    class CC1,CC2,CCn cc
    class IM1,IM2,IMn im
```

我们现在按自顶向下的顺序，介绍这三个层。


### 平台

平台（Platform）是与参赛者交互的唯一界面。它采取前后端分离实现，技术选型表如下：

<table>
  <thead>
    <tr>
      <th>组件</th>
      <th>运行环境</th>
      <th>选型</th>
      <th>版本</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td rowspan="5">后端</td>
      <td rowspan="5">Kotlin 2.2 / GraalVM JDK 24</td>
      <td>Spring Boot</td>
      <td>3.5.6</td>
    </tr>
    <tr>
      <td>Spring Web MVC</td>
      <td rowspan="3">跟随 Spring Boot</td>
    </tr>
    <tr>
      <td>Spring Data JDBC</td>
    </tr>
    <tr>
      <td>Spring Security</td>
    </tr>
    <tr>
      <td>GraalPy</td>
      <td>跟随 GraalVM</td>
    </tr>
    <tr>
      <td>关系型数据库</td>
      <td>-</td>
      <td>PostgreSQL</td>
      <td>18</td>
    </tr>
    <tr>
      <td>对象存储</td>
      <td>-</td>
      <td>MinIO</td>
      <td>latest</td>
    </tr>
    <tr>
      <td>反向代理</td>
      <td>-</td>
      <td>Nginx</td>
      <td>latest</td>
    </tr>
  </tbody>
</table>


几个关键点：
- 用户信息仅在平台中存储。后方的题目中心、实例管理器都不知道用户的存在。
- 平台完全不管理题目内容。逻辑上，它只是担任用户的 agent，向题目中心请求题目内容、申请靶机、提交 flag 并获取 flag 验证结果。不过在实践上，平台会缓存很多东西（如题目描述、附件、可在平台侧执行的 checker 等）。
- 平台负责管理赛事。赛事业务指的是：赛事数据管理（例如公告板、比赛开始时间和结束时间）；题目的编排（包括顺序和标签）；分数的维护；排行榜的生成。
- 用户必须能通过平台服务器的端口访问靶机。这需要平台服务器执行一些端口转发任务。

### 题目中心

题目中心有两个职责：管理题目，以及维护靶机。甚至可以说，这两个功能几乎是独立的——所有类型的题目中心都可以复用同一套题目管理逻辑（因为题目的字段是固定的），但靶机管理方式千差万别。根据平台发来的请求，题目中心要做到：申请靶机；释放靶机；靶机延期；执行靶机侧脚本（例如验证 patch 是否成功）。

前文提到，平台服务器会用自己的端口作为靶机端口之镜像。所以，平台服务器本身必须能访问靶机，否则端口转发无法进行。一般情况下这不成问题，但不排除有极端情况，使得题目中心可以直连靶机而平台服务器不能。此时需要题目中心也做端口转发。

Cranberry 提供三种官方题目中心：Docker 型（包括单容器和多容器，基于 Docker Swarm）、VM 型（基于 PVE）、静态共享型（即题目中心只管理题目，不管理靶机的生命周期，由出题人自行启动共享靶机并将 ip、端口填入题目信息中）。大部分场合下，这几种题目中心已经足够赛事使用。不过，二次开发者也可以 DIY 自己的题目中心。举个例子：假设你想在 Cranberry 上聚合第三方平台的题（类似于 [vjudge](https://vjudge.net/)），则你可以实现一个题目中心，申请靶机时就向第三方平台请求容器，然后转发端口。



### 实例管理器

实例管理器一般是第三方的容器编排引擎或 hypervisor，如 Docker Swarm、K8s、PVE、CloudStack、OpenStack。

实例管理器与题目中心是一一对应的，题目中心会直接向实例管理器发送指令。官方提供的题目中心，对应的实例管理器是 Docker Swarm 和 PVE，它们都有集群能力，但是我们一般推荐单计算节点部署。如果你想使用 K8s 担任实例管理器，那么你需要 DIY 一个题目中心——别担心，我们不会让你写重复的题库管理代码。详情参考[《二次开发指南》](/docs/guide/二次开发指南/)的相关章节。

